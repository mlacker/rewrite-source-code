# Multi Version Store Engine

多版本存储引擎（MVSE）是用以解决红猫设计版本的技术实现方案，基于 MySQL 数据库和消息队列中间件，为系统元数据的存储提供低延迟、实时存储的能力，具备良好的弹性伸缩能力，随着业务规模增长可轻松的横向扩展系统处理能力。

存储是指用于存储平台设计产生的元数据，而多版本即意味着在同一时刻所有的历史版本都能存储于系统当中。

## 为什么需要它？

首先我们看一下为什么需要它，以及它能解决什么问题？

### 版本

众所周知**红猫低代码开发平台-专业版**是一款开发设计类型的平台，而**设计**是人的思维演变过程，存在迭代、尝试、回滚、重做、分支等现象。不同于一般的事务性业务，如产品信息管理，组织机构管理，购买商品创建订单，在数据库中只需要保存**当前状态**的数据即可，很少会有对数据历史版本查询的诉求。因此对于一个设计类型的系统，**版本**是一个非常重要的概念。

### 团队协作

既然是用开发平台去开发项目，则通常不是由一个人能完成一个项目的开发任务，是由多个人组成的团队共同协作去实施项目。如果不能处理团队协作的问题，则不能发挥一个开发平台的价值，所以团队协作功能也是低代码开发平台的核心之一。

从一个人拥有数据的所属和维护权到多个人共同拥有数据的维护权衍生出了新的问题，我们可以把这种现象抽象成计算机从单线程执行任务，到多线程并发执行任务并且共享的一份数据，存在并发修改数据冲突和数据一致性的问题。

举个栗子，小明和小伟接到任务需要共同完成一个网站的首页，但两人分别负责首页的 UI 美化和首页的内容制作。由于开发的过程是从一个不稳定的状态趋向于稳定的成果，两人都不想在做自己的工作的同时受到对方的影响导致工作无法进展。所以两人都需要有一份自己设计数据的**版本**，它是独立的不受其它人提交所影响。当任务完成到某个阶段后，可以**合并**到一起查看效果。在这里再一次提出**版本**这个重要的概念，以及如何将两个独立的版本（设计数据）**合并**到一起的新问题。

### 工作流引擎

工作流对于国内的企业级系统是必不可少的一个环节，由于工作流的特性，每一个发起的流程实例属于长事务的形态，而流程的设计也需要随着时间迭代修改，因此版本是工作流实现的基础体系。而三代基于代码生成的体系，同时生成所有历史版本的业务代码也不是最佳的方案，以多版本存储引擎作为支撑能解决这一问题，能提供更好的实现方案，会在后文逐步解析。

### 实时保存

满足禄恒（坑）的需求，希望该系统能实现实时保存的能力，即用户在浏览器中设计的数据，不论因何原因导致页面关闭，也不会丢失设计数据。对用户来说，有时候丢失一些重要的数据是令人非常懊恼的一件事情，虽然是一个很好的想法，但在当时看起来基本不可能实现。因为三代的数据结构不同于二代，二代保存数据是以单个表单、报表、流程的颗粒度进行存储，大家设计相同表单的冲突概率低（假如设计同一个表单，会存在覆盖更新的问题）。而三代是以模块为粒度进行保存，单次提交的模块设计大约在 1MB 左右，如果需要实现实时保存就需要近乎实时的频繁提交数据到服务器，不仅服务器无法承受，数据的存取延迟还很高。

### Git

## 逐步实现

现在思考一下该如何实现，首先我们需要满足版本的特性
