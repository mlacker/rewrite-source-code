# Distributed

## 理论

### CAP

CAP 原则又称 CAP 定理，指的是在一个分布式系统中 Consistency（一致性), Availability（可用性）, Partition tolerance（分区容错性）三者不可兼得。

- 一致性（C）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。
- 可用性（A）：
- 分区容忍性（P）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。

### BASE

Basically Available（基本可用）, Soft state（软状态）, Eventually consistent（最终一致性）

## 服务发现

测试网络故障下 eureka，nacos，zookeeper 的行为

## 负载均衡

## 熔断

## 降级

### 服务降级

### 请求降级

### 缓存降级

指当访问量剧增，服务出现问题（如响应时间慢或不响应）或非核心服务影响到核心流程的性能时，即使是有损部分其它服务，仍然需要保证主服务可用。可以将其他次要服务的数据进行缓存降级，从而提升主服务的稳定性。

## 限流

### 固定窗口计数

记录首个请求的开始时间，在限定时间区间内的请求统计。若超过区间则开启新一轮统计。

实现最简单的模型，缺乏实时性和准确性，假设限定 10s 不能超过 100 个请求，前 9s 没有任何请求，第 10s 和下一个时间周期的 11s 分别进入 100 个请求，则服务器在 2s 内瞬间接收到 200 个请求，超过服务器负载。

### 滑动窗口计数

把时间以一定比例分片，统计分片单位时间内的请求量。窗口包含多个时间分片，并且随着时间向前滚动，对窗口内的分片进行求和。

低粒度的时间分片一定程度解决了固定窗口存在的问题。

实时性则是对性能和准确性的衡量，在规定的时间窗口内要求任意刻（瞬态）的请求总量不超过要求则需要实时计算能力，开销相对较大。而通过时间片段的统计，并缓存历史片段的结果则减少了计算量，虽然也降低了实时性和准确性。

其次，在高并发的系统中，并非要求十分精确的限制。而且，流量的计量也要附有时间单位才有意义。

### 信号量计数/线程池

限制同一时间的最大请求数量，根据请求时间长短与吞吐量成反比。

### 桶算法

往桶中以任意的速率流入水，以一定速率流出水。当水超过桶流量则丢弃，因为桶的容量是不变的，保证了整体的速率。

以一定的速率输出请求，限制流量不会超过该速率，有整流的效果。

### 令牌桶

以固定的速率生成令牌，在请求处理之前需要获取一个令牌，请求处理完毕后将这个令牌丢弃。

允许在规定时间内的突峰流量，随后的流量则根据令牌的生成速率限制，若流量较少时可以累积令牌。

Guava 的 RateLimiter 提供了令牌桶算法实现：平滑突发限流（SmoothBursty）和平滑预热限流（SmoothWarmingUp）实现。

## 监控

### 性能指标

如何实现 RT 统计

### 负载

### 告警

## 后备方案

## 其它

首先对目标系统进行测量，负载测试、压力测试。明确系统的各环节的性能指标，吞吐量、延时，以及资源负载情况。针对薄弱环节进行优化。
并且预估容量，尤其是高峰期的负载进行容量规划。应用熔断和限流避免服务雪崩现象，识别关键业务和非关键业务，必要时可以降级非关键业务以保障关键业务的运行。最后要做好后备方案的应急措施。

### 微服务架构和单体架构的区别

单体架构中多个模块包含在一个应用中，

- 结构简单清晰，开发成本低
- 避免了分布式的治理和问题

微服务架构

- 模块的边界清晰，低耦合，职责单一
- 模块可以独立的伸缩
- 模块的升级不影响其它模块
- 模块的故障不影响其它模块
- 可以使用异构技术栈
- 数据库相互独立，垂直分割，提升写负载能力

### TODO

研究限流框架实现

- Hystrix
- Sentinal
- RateLimiter

重试操作

操作的幂等性

基于 hash 分片的数据，在进行扩容时，最好以容量的倍数进行扩容，以减少数据再均衡带来的开销。
